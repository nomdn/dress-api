<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dress API</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.5.27/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/element-plus@2.8.0/dist/index.full.min.js"></script>
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus@2.8.0/dist/index.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus@2.8.0/theme-chalk/dark/css-vars.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/misans@4.1.0/lib/Normal/MiSans-Regular.min.css" /> 
  <style>
    a{
      color: #409eff;
      text-decoration: none;
    }
    h1 {
      font-family: "MiSans";
    }
    el-card {
      font-family: "MiSans";
    }
    el-empty {
      font-family: "MiSans";
    }
    #app {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .author-card {
      margin-bottom: 16px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      padding: 16px 0;
    }
    .image-preview {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: block;
    }
    .image-info {
      padding-top: 5px;
      text-align: center;
      font-size: 12px;
      color: #909399;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
  </style>
</head>
<body>
  <div id="app">
    
    <h1>{{ title }}</h1>
    <h3>本项目图片资源来自<a href="https://github.com/Cute-Dress/Dress">Cute-Dress/Dress</a>,使用请遵守<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans">CC BY-NC-SA 4.0</a>协议！</h3>

    <!-- 按作者分组的可折叠卡片 -->
    <el-card 
      v-for="(author, authorName) in groupedImages" 
      :key="authorName"
      class="author-card"
      shadow="hover"
    >
      <template #header>
        <div class="card-header" @click="toggleExpand(authorName)">
          <span style="font-weight: bold; font-size: 18px;">
            {{ authorName }} ({{ author.length }} 张图片)
          </span>
          <el-button 
            type="text" 
            size="small"
            :icon="expandedAuthors[authorName] ? 'ArrowUp' : 'ArrowDown'"
          >
            {{ expandedAuthors[authorName] ? '收起' : '展开' }}
          </el-button>
        </div>
      </template>

      <!-- 只在展开时渲染图片（懒加载） -->
      <div v-if="expandedAuthors[authorName]" class="image-grid">
        <div v-for="(image, idx) in author" :key="idx" class="image-card">
          <img 
            :src="imgBaseURL + image.path" 
            :alt="image.path"
            @error="handleImageError"
            class="image-preview"
          />
          <div class="image-info">
            {{ formatDate(image.latest_commit_time) }}
          </div>
        </div>
      </div>
    </el-card>

    <el-empty 
      v-if="Object.keys(groupedImages).length === 0" 
      description="暂无数据"
      style="margin-top: 40px;"
    />
    
  </div>
  <footer style="max-width: 1000px;margin: 0 auto;padding: 20px;text-align: center;"><a href="https://github.com/nomdn/dress-api/">Dress-API</a> | <a href="https://github.com/Cute-Dress">Dress</a> | <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans">CC BY-NC-SA 4.0</a> | <a href="https://icp.gov.moe/?keyword=20260039" target="_blank">萌ICP备20260039号</a></footer>

  <script>
    const { createApp, ref, onMounted, reactive } = Vue;
    const { ElCard, ElButton, ElEmpty } = ElementPlus;

    const app = createApp({
      setup() {
        const title = ref("Dress API - 随机图片");
        const groupedImages = ref({});
        /* 这取决于你部署的API地址 */
        const remoteAPI = ref('https://dress.wsmdn.top/');
        const imgBaseURL = ref('https://fastly.jsdelivr.net/gh/Cute-Dress/Dress@master/');
        // 记录哪些作者被展开 { "Alice": true, "Bob": false }
        const expandedAuthors = reactive({});

        const loadJsonData = async () => {
          try {
            const response = await fetch('index_1.json');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            groupedImages.value = data;

            // 初始化：全部折叠
            for (const author in data) {
              expandedAuthors[author] = false;
            }
          } catch (err) {
            console.error(err);
            alert('加载数据失败: ' + err.message);
          }
        };

        const toggleExpand = (authorName) => {
          expandedAuthors[authorName] = !expandedAuthors[authorName];
        };

        const formatDate = (dateString) => {
          if (!dateString) return '未知时间';
          const date = new Date(dateString);
          return date.toLocaleDateString('zh-CN');
        };

        const handleImageError = (e) => {
          e.target.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><rect width="200" height="200" fill="%23000000"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="14" fill="%23F8F8FF">图片无法加载</text></svg>';
        };

        axios.get(remoteAPI.value+"health")
          .then(res => {
            console.log('远程API响应:', res.data);
            // 注意：axios自动解析JSON，不需要手动调用res.json()
            const data = res.data;
            console.log('远程API JSON数据:', data);
            if (data.minimum_mode == "false"){
              console.log('远程API正常，使用远程API地址加载图片');
              imgBaseURL.value = remoteAPI.value+"img/";
            }else{
              const cdnURLs = [
                "https://cdn.jsdelivr.net/",
                "https://fastly.jsdelivr.net/",
                "https://gcore.jsdelivr.net/",
                "https://testingcf.jsdelivr.net/"
              ];
              for (const cdn of cdnURLs) {
                const testURL = cdn + "gh/Cute-Dress/Dress@master/README.md";
                axios.get(testURL)
                  .then(() => {
                    imgBaseURL.value = cdn + "gh/Cute-Dress/Dress@master/";
                    console.log('使用CDN:', imgBaseURL.value);
                  })
                  .catch(() => {
                    console.warn('CDN不可用:', cdn);
                  });
              }
            }
          })
          .catch(err => {
            console.error('远程API请求失败:', err);
          });
        

        onMounted(() => {
          loadJsonData();
        });

        return {
          title,
          groupedImages,
          expandedAuthors,
          toggleExpand,
          formatDate,
          handleImageError,
          imgBaseURL
        };
      }
    });

    app.use(ElementPlus);
    app.mount("#app");
  </script>
</body>
</html>